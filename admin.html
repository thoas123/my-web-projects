<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Drive Hub Motors</title>
    <link rel="stylesheet" href="styles/main.css">
    <style> /* Page-specific styles */
        h2 { text-align: center; margin: 20px 0; color: #121826; }
        /* Buttons for actions */
.list-item-actions button {
  padding: 6px 12px;
  margin: 2px 0;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: transform 0.1s ease;
}

.list-item-actions button:hover {
  transform: scale(1.05);
}

.list-item-actions button[data-action="approve"] {
  background-color: #1f7a7a;
  color: white;
}

.list-item-actions button[data-action="complete"] {
  background-color: #3d5a80;
  color: white;
}

.list-item-actions button[data-action="cancel"] {
  background-color: #d24c3d;
  color: white;
}

/* Hover effect for order cards */
.list-item {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 16px;
  padding: 16px;
  display: flex;
  gap: 15px;
  align-items: center;
  box-shadow: 0 10px 24px rgba(12, 16, 24, 0.12);
  border: 1px solid rgba(18, 24, 38, 0.08);
  transition: transform 0.2s, box-shadow 0.2s;
}

.list-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 16px 30px rgba(12, 16, 24, 0.18);
}

.list-item img {
  width: 120px;
  height: 80px;
  object-fit: cover;
  border-radius: 10px;
}

/* Styles for Contact Messages Section */
.messages-section h3 {
    text-align: center;
    margin: 40px 0 20px 0;
    color: #121826;
}

.message-item {
    background-color: #fffaf2;
    border-left: 4px solid #f0a03a;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(12, 16, 24, 0.08);
}

    </style>
</head>
<body>
    <h2>Admin Dashboard</h2>
    <div id="orders-list" class="list-container"></div>
    <div class="messages-section list-container">
        <h3>Contact Messages</h3>
        <div id="messages-list"></div>
    </div>

    <footer>
        <p>&copy; 2025 Drive Hub Motors | All Rights Reserved</p>
    </footer>

<script src="scripts/shared.js" type="module"></script>
<script src="scripts/auth.js" type="module"></script>
<script src="scripts/modal.js"></script>
<script type="module">
const API_BASE_URL = 'http://localhost:3000';

document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role');

  if (!token || role !== 'admin') {
    window.location.href = "login.html";
    return;
  }

  await loadOrders();
  await loadMessages();

  document.getElementById("orders-list").addEventListener("click", async (e) => {
    if (e.target.tagName !== 'BUTTON' || !e.target.dataset.action) return;

    const id = e.target.dataset.id;
    const action = e.target.dataset.action;

    const confirmed = await showConfirmation(`Are you sure you want to ${action} this order?`);
    if (!confirmed) return;

    try {
      await updateOrderStatus(id, action);
      loadOrders();
    } catch (error) {
      console.error(`Failed to ${action} order:`, error);
      showMessage(`Failed to ${action} order. Please try again.`);
    }
  });
});

// Load all orders for admin
async function loadOrders() {
  const container = document.getElementById("orders-list");
  container.innerHTML = "<p>Loading orders...</p>";

  showSpinner();
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_BASE_URL}/api/admin/orders`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) {
      if (res.status === 401) {
        showMessage("Session expired. Please log in again.");
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        window.location.href = 'login.html';
      }
      throw new Error(`Server responded with ${res.status}`);
    }

    const orders = await res.json();
    container.innerHTML = "";

    if (orders.length === 0) {
      container.innerHTML = "<p class='empty-message'>No orders yet.</p>";
      return;
    }

    orders.forEach(order => {
      const div = document.createElement("div");
      div.className = "list-item";
      const formattedPrice = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(order.price);

      div.innerHTML = `
        <img src="${order.img}" alt="${order.name}">
        <div class="list-item-details">
          <h3>${order.name}</h3>
          <p>Price: ${formattedPrice}</p>
          <p>User: ${order.userEmail || 'N/A'}</p>
          <p>Date: ${order.date}</p>
          <p>Status: <span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></p>
        </div>
        <div class="list-item-actions">
          ${order.status === 'Pending' ? `<button data-id="${order.id}" data-action="approve">Approve</button>` : ''}
          ${order.status === 'Approved' ? `<button data-id="${order.id}" data-action="complete">Complete</button>` : ''}
          ${order.status !== 'Completed' && order.status !== 'Canceled' ? `<button data-id="${order.id}" data-action="cancel">Cancel</button>` : ''}
        </div>
      `;
      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p class='empty-message'>Failed to load orders. Check console.</p>";
  } finally {
    hideSpinner();
  }
}

// Load all contact messages for admin
async function loadMessages() {
    const container = document.getElementById("messages-list");
    container.innerHTML = "<p>Loading messages...</p>";

    showSpinner();
    try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/api/admin/messages`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Server responded with ${res.status}`);

        const messages = await res.json();
        container.innerHTML = "";

        if (messages.length === 0) {
            container.innerHTML = "<p class='empty-message'>No contact messages received.</p>";
            return;
        }

        messages.forEach(msg => {
            const div = document.createElement("div");
            div.className = "message-item";
            div.innerHTML = `
                <p><strong>From:</strong> ${msg.name} (<em>${msg.email}</em>)</p>
                <p><strong>Message:</strong> ${msg.message}</p>
                <p><small>Received: ${msg.receivedDate}</small></p>
            `;
            container.appendChild(div);
        });
    } catch (err) {
        console.error(err);
        container.innerHTML = "<p class='empty-message'>Failed to load messages.</p>";
    } finally {
        hideSpinner();
    }
}

// Update order status (Approve, Complete, Cancel)
async function updateOrderStatus(id, action) {
  const token = localStorage.getItem('token');
  showSpinner();
  
  // The endpoint path is constructed directly from the action (e.g., 'approve', 'cancel')
  let endpoint;
  if (action === 'cancel') {
    endpoint = `/api/orders/${id}/${action}`; // Shared cancel endpoint
  } else {
    endpoint = `/api/admin/orders/${id}/${action}`; // Admin-specific endpoints
  }

  const res = await fetch(`${API_BASE_URL}${endpoint}`, {
    method: 'PUT',
    headers: { 'Authorization': `Bearer ${token}` }
  });

  if (!res.ok) throw new Error(`Server responded with ${res.status}`);
  const data = await res.json();
  showMessage(data.message || 'Order updated successfully');
  hideSpinner();
}

</script>

</body>
</html>


